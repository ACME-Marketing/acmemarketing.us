---
import MotionReveal from '../../components/MotionReveal';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { graphQLClient, gql } from '../../lib/graphql';

export async function getStaticPaths() {
  const GET_ALL_POST_SLUGS = gql`
    query GetAllPostSlugs {
      posts {
        nodes {
          uri
        }
      }
    }
  `;
  const data = await graphQLClient.request(GET_ALL_POST_SLUGS);
  return data.posts.nodes.map((post) => ({
    params: { slug: post.uri.replace(/\/$/, '') },
  }));
}

const GET_SINGLE_POST = gql`
  query GetSinglePost($uri: String!) {
    postBy(uri: $uri) {
      title
      content
      featuredImage {
        node {
          sourceUrl
          altText
          mediaDetails {
            width
            height
          }
        }
      }
      tags {
        nodes {
          name
          slug
        }
      }
    }
  }
`;

const { slug } = Astro.params;
const uri = `/${slug}/`;

let post = null;
let allPosts = [];

try {
  const data = await graphQLClient.request(GET_SINGLE_POST, { uri });
  post = data.postBy;

  const GET_ALL_POSTS = gql`
    query GetAllPosts($tagSlugs: [String]) {
      posts(first: 100, where: { tagSlugIn: $tagSlugs }) {
        nodes {
          title
          uri
          tags {
            nodes {
              slug
            }
          }
        }
      }
    }
  `;
  const currentPostTags = post.tags.nodes.map(tag => tag.slug);
  const tagSlugsToFilter = [...new Set([...currentPostTags, "all"])];
  const allPostsData = await graphQLClient.request(GET_ALL_POSTS, { tagSlugs: tagSlugsToFilter });
  allPosts = allPostsData.posts.nodes;
} catch (error) {
  console.error("Error fetching post or all posts:", error);
}

if (!post) {
  return Astro.redirect('/404');
}

const currentPostIndex = allPosts.findIndex(p => p.uri === uri);
const prevPost = currentPostIndex > 0 ? allPosts[currentPostIndex - 1] : null;
const nextPost = currentPostIndex < allPosts.length - 1 ? allPosts[currentPostIndex + 1] : null;
const sidebarPosts = allPosts.filter(p => p.uri !== uri).slice(0, 5);
---

<BaseLayout title={post.title}>
  <div class="w-full">

    <!-- Hero Header -->
    <header class="relative h-[60vh] bg-black overflow-hidden flex items-center justify-center">
      <div class="absolute inset-0 z-0">
        {post.featuredImage?.node?.sourceUrl && (
          <img 
            src={post.featuredImage.node.sourceUrl} 
            alt={post.featuredImage.node.altText || post.title}
            class="w-full h-full object-cover opacity-20 blur-sm scale-105"
          />
        )}
        <div class="absolute inset-0 bg-gradient-to-br from-black via-blue-900 to-black opacity-80"></div>
      </div>

      {/* — WRAP THIS BLOCK FOR FADE-IN HERO TEXT — */}
      <MotionReveal>
        <div class="relative z-10 text-center px-6">
          <h1 class="text-5xl md:text-6xl font-extrabold text-white leading-tight drop-shadow-xl">
            {post.title}
          </h1>
          <p class="text-cyan-400 mt-4 text-xl font-medium tracking-wide">
            AI-first. Results-driven. Future-ready.
          </p>
        </div>
      </MotionReveal>
    </header>

    <!-- Main Layout -->
    <div class="container mx-auto px-4 py-16 flex flex-col lg:flex-row gap-12">

      <!-- Main Content -->
      {/* — WRAP ARTICLE CONTENT FOR SLIDE-UP — */}
      <MotionReveal delay={0.2}>
        <main class="lg:w-3/4">
          <article class="bg-white rounded-3xl shadow-2xl p-10 prose prose-xl max-w-none prose-blue">
            <div set:html={post.content}></div>
          </article>
        </main>
      </MotionReveal>

      <!-- Animated CTA -->
      {/* — WRAP CTA FOR POP-IN EFFECT — */}
      <MotionReveal delay={0.4}>
        <section class="mt-16 relative rounded-3xl p-10 bg-gradient-to-br from-cyan-500 to-blue-700 text-white shadow-2xl overflow-hidden lg:absolute lg:top-[70%] lg:right-0 lg:translate-y-[-50%]">
          <div class="absolute top-0 right-0 w-80 h-80 bg-white/10 rounded-full blur-3xl"></div>
          <div class="absolute bottom-0 left-0 w-80 h-80 bg-white/10 rounded-full blur-3xl"></div>
          <div class="relative z-10 text-center">
            <h3 class="text-4xl font-extrabold mb-4">Ready to Scale with AI?</h3>
            <p class="text-lg mb-6">
              Download our free guide: <em>"AI Automation: Table Stakes for Every Company"</em>
            </p>
            <a
              href="#"
              id="open-ebook-modal-post"
              class="inline-block bg-white text-blue-800 font-bold py-3 px-8 rounded-full text-lg hover:bg-gray-100 transition transform hover:scale-105"
            >
              Grab Yours Now
            </a>
          </div>
        </section>
      </MotionReveal>

      <!-- Prev / Next Navigation (no animation) -->
      <div class="flex justify-between mt-14 text-blue-600 font-semibold text-lg">
        {prevPost && (
          <a href={`/posts/${prevPost.uri.replace(/^\/|\/$/g, '')}`} class="hover:underline">
            &laquo; {prevPost.title}
          </a>
        )}
        {nextPost && (
          <a href={`/posts/${nextPost.uri.replace(/^\/|\/$/g, '')}`} class="hover:underline ml-auto">
            {nextPost.title} &raquo;
          </a>
        )}
      </div>

      <!-- Sidebar -->
      {/* — WRAP SIDEBAR FOR STAGGERED FADE-IN — */}
      <MotionReveal delay={0.6}>
        <aside class="lg:w-1/4 space-y-8">
          <div class="bg-white p-6 rounded-3xl shadow-xl border border-blue-100">
            <h3 class="text-2xl font-bold mb-4 text-gray-900">Recent Posts</h3>
            <ul class="space-y-3">
              {sidebarPosts.map((p) => (
                <li>
                  <a
                    href={`/posts/${p.uri.replace(/^\/|\/$/g, '')}`}
                    class="text-blue-600 hover:underline font-medium"
                  >
                    {p.title}
                  </a>
                </li>
              ))}
            </ul>
          </div>

          <div class="bg-gradient-to-br from-cyan-100 to-blue-200 p-6 rounded-3xl border-l-4 border-blue-500 shadow-lg">
            <h4 class="text-xl font-bold text-blue-800 mb-2">Free Ebook</h4>
            <p class="text-sm text-gray-800 mb-4">
              Master the fundamentals of automating your business with AI.
            </p>
            <a
              href="#"
              id="open-ebook-modal-sidebar"
              class="inline-block bg-blue-600 text-white font-bold py-2 px-5 rounded-full text-sm hover:bg-blue-700 transition"
            >
              Get Yours Now
            </a>
          </div>
        </aside>
      </MotionReveal>

    </div>
  </div>
</BaseLayout>
