---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { graphQLClient, gql } from '../../lib/graphql';

export async function getStaticPaths() {
  const GET_ALL_POST_SLUGS = gql`
    query GetAllPostSlugs {
      posts {
        nodes {
          uri
        }
      }
    }
  `;
  const data = await graphQLClient.request(GET_ALL_POST_SLUGS);
  return data.posts.nodes.map((post) => ({
    params: { slug: post.uri.replace(/\/$/, '') },
  }));
}

const GET_SINGLE_POST = gql`
  query GetSinglePost($uri: String!) {
    postBy(uri: $uri) {
      title
      content
      featuredImage {
        node {
          sourceUrl
          altText
          mediaDetails {
            width
            height
          }
        }
      }
      tags {
        nodes {
          name
          slug
        }
      }
    }
  }
`;

const { slug } = Astro.params;
const uri = `/${slug}/`;

let post = null;
let allPosts = [];

try {
  const data = await graphQLClient.request(GET_SINGLE_POST, { uri });
  post = data.postBy;
  console.log("Fetched single post:", post);

  // Fetch all posts to determine previous/next and sidebar
  const GET_ALL_POSTS = gql`
    query GetAllPosts($tagSlugs: [String]) {
      posts(first: 100, where: { tagSlugIn: $tagSlugs }) { # Fetch a reasonable number of posts
        nodes {
          title
          uri
          tags {
            nodes {
              slug
            }
          }
        }
      }
    }
  `;
  const currentPostTags = post.tags.nodes.map(tag => tag.slug);
  const tagSlugsToFilter = [...new Set([...currentPostTags, "all"])]; // Include "all" tag
  const allPostsData = await graphQLClient.request(GET_ALL_POSTS, { tagSlugs: tagSlugsToFilter });
  allPosts = allPostsData.posts.nodes;
  console.log("Fetched all posts for sidebar/nav:", allPosts);

} catch (error) {
  console.error("Error fetching post or all posts:", error);
}

if (!post) {
  console.error("Post not found for URI:", uri);
  return Astro.redirect('/404'); // Redirect to a 404 page if post not found
}

// Logic for previous/next posts and sidebar (to be implemented)
const currentPostIndex = allPosts.findIndex(p => p.uri === uri);
const prevPost = currentPostIndex > 0 ? allPosts[currentPostIndex - 1] : null;
const nextPost = currentPostIndex < allPosts.length - 1 ? allPosts[currentPostIndex + 1] : null;

const sidebarPosts = allPosts.filter(p => p.uri !== uri).slice(0, 5); // Get 5 other posts for sidebar
---

<BaseLayout title={post.title}>
  <div class="container mx-auto px-4 py-8 flex flex-col lg:flex-row gap-8">
    <!-- Main Content Area -->
    <main class="lg:w-3/4">
      <article class="bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-4xl font-extrabold mb-4">{post.title}</h1>
        {post.featuredImage && post.featuredImage.node && (
          <img 
            src={post.featuredImage.node.sourceUrl} 
            alt={post.featuredImage.node.altText || post.title} 
            width={post.featuredImage.node.mediaDetails.width} 
            height={post.featuredImage.node.mediaDetails.height} 
            class="w-full max-h-96 object-cover rounded-md mb-6"
          />
        )}
        <div class="prose max-w-none" set:html={post.content} />
      </article>

      <div class="text-center mt-12 p-8 bg-blue-50 border-l-4 border-blue-500 rounded-lg shadow-md">
        <h3 class="text-3xl font-bold text-blue-800 mb-4">Unlock Your Future!</h3>
        <p class="text-lg text-gray-700 mb-6">Download our FREE ebook: <strong>"AI Automation: Table Stakes for Every Company"</strong> and discover how to stay ahead in the competitive landscape.</p>
        <a href="#" id="open-ebook-modal-post" class="inline-block bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105">Grab Yours Now</a>
      </div>

      <!-- Previous/Next Navigation -->
        <div class="flex justify-between mt-8">
          {prevPost && <a href={`/posts/${prevPost.uri.replace(/^\/|\/$/g, '')}`} class="text-blue-600 hover:underline">&laquo; Previous Post</a>}
          {nextPost && <a href={`/posts/${nextPost.uri.replace(/^\/|\/$/g, '')}`} class="text-blue-600 hover:underline ml-auto">Next Post &raquo;</a>}
        </div>
    </main>

    <!-- Sidebar -->
    <aside class="lg:w-1/4 bg-white rounded-lg shadow-lg p-6">
      <h3 class="text-2xl font-bold mb-4">Recent Posts</h3>
      <ul>
        {sidebarPosts.map((p) => (
          <li class="mb-2">
            <a href={`/posts/${p.uri.replace(/^\/|\/$/g, '')}`} class="text-blue-600 hover:underline">{p.title}</a>
          </li>
        ))}
      </ul>

      <div class="mt-8 p-6 bg-blue-50 border-l-4 border-blue-500 rounded-lg shadow-md hidden lg:block">
        <h4 class="text-xl font-bold text-blue-800 mb-3">Get Your Free Ebook!</h4>
        <p class="text-sm text-gray-700 mb-4">AI automation is now table stakes for every company.</p>
        <a href="#" id="open-ebook-modal-sidebar" class="inline-block bg-blue-600 text-white font-bold py-2 px-5 rounded-full text-sm hover:bg-blue-700 transition duration-300">Get Yours Now</a>
      </div>
    </aside>
  </div>
</BaseLayout>