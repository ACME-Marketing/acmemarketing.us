---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { graphQLClient, gql } from '../../lib/graphql';

export async function getStaticPaths() {
  const GET_ALL_POST_SLUGS = gql`
    query GetAllPostSlugs {
      posts {
        nodes {
          uri
        }
      }
    }
  `;
  const data = await graphQLClient.request(GET_ALL_POST_SLUGS);
  return data.posts.nodes.map((post) => ({
    params: { slug: post.uri.replace(/\/$/, '') },
  }));
}

const GET_SINGLE_POST = gql`
  query GetSinglePost($uri: String!) {
    postBy(uri: $uri) {
      title
      content
      featuredImage {
        node {
          sourceUrl
          altText
          mediaDetails {
            width
            height
          }
        }
      }
      tags {
        nodes {
          name
          slug
        }
      }
    }
  }
`;

const { slug } = Astro.params;
const uri = `/${slug}/`;

let post = null;
let allPosts = [];

try {
  const data = await graphQLClient.request(GET_SINGLE_POST, { uri });
  post = data.postBy;

  const GET_ALL_POSTS = gql`
    query GetAllPosts($tagSlugs: [String]) {
      posts(first: 100, where: { tagSlugIn: $tagSlugs }) {
        nodes {
          title
          uri
          tags {
            nodes {
              slug
            }
          }
        }
      }
    }
  `;
  const currentPostTags = post.tags.nodes.map(tag => tag.slug);
  const tagSlugsToFilter = [...new Set([...currentPostTags, "all"])];
  const allPostsData = await graphQLClient.request(GET_ALL_POSTS, { tagSlugs: tagSlugsToFilter });
  allPosts = allPostsData.posts.nodes;

} catch (error) {
  console.error("Error fetching post or all posts:", error);
}

if (!post) {
  return Astro.redirect('/404');
}

const currentPostIndex = allPosts.findIndex(p => p.uri === uri);
const prevPost = currentPostIndex > 0 ? allPosts[currentPostIndex - 1] : null;
const nextPost = currentPostIndex < allPosts.length - 1 ? allPosts[currentPostIndex + 1] : null;
const sidebarPosts = allPosts.filter(p => p.uri !== uri).slice(0, 5);
---

<BaseLayout title={post.title}>
  <div class="container mx-auto px-4 py-16 flex flex-col lg:flex-row gap-10">
    
    <!-- Main Content -->
    <main class="lg:w-3/4">
      <article class="bg-white rounded-2xl shadow-lg p-10">
        <h1 class="text-4xl font-extrabold mb-6 leading-tight text-gray-900">{post.title}</h1>

        {post.featuredImage?.node?.sourceUrl && (
          <img 
            src={post.featuredImage.node.sourceUrl} 
            alt={post.featuredImage.node.altText || post.title} 
            width={post.featuredImage.node.mediaDetails.width} 
            height={post.featuredImage.node.mediaDetails.height} 
            class="w-full max-h-[28rem] object-cover rounded-lg mb-8"
          />
        )}

        <div class="prose prose-lg max-w-none text-gray-800" set:html={post.content} />
      </article>

      <!-- CTA -->
      <section class="text-center mt-12 p-10 bg-gradient-to-r from-cyan-500 to-blue-600 text-white rounded-2xl shadow-xl">
        <h3 class="text-3xl font-bold mb-4">Unlock Your Future!</h3>
        <p class="text-lg mb-6">Download our FREE ebook: <strong>"AI Automation: Table Stakes for Every Company"</strong></p>
        <a href="#" id="open-ebook-modal-post" class="inline-block bg-white text-blue-800 font-bold py-3 px-8 rounded-full text-lg hover:bg-gray-100 transition transform hover:scale-105">
          Grab Yours Now
        </a>
      </section>

      <!-- Post Navigation -->
      <div class="flex justify-between mt-12 text-blue-600 font-semibold text-lg">
        {prevPost && (
          <a href={`/posts/${prevPost.uri.replace(/^\/|\/$/g, '')}`} class="hover:underline">
            &laquo; {prevPost.title}
          </a>
        )}
        {nextPost && (
          <a href={`/posts/${nextPost.uri.replace(/^\/|\/$/g, '')}`} class="hover:underline ml-auto">
            {nextPost.title} &raquo;
          </a>
        )}
      </div>
    </main>

    <!-- Sidebar -->
    <aside class="lg:w-1/4 space-y-8">
      <div class="bg-white p-6 rounded-2xl shadow-lg">
        <h3 class="text-xl font-bold mb-4">Recent Posts</h3>
        <ul class="space-y-2">
          {sidebarPosts.map((p) => (
            <li>
              <a href={`/posts/${p.uri.replace(/^\/|\/$/g, '')}`} class="text-blue-600 hover:underline">
                {p.title}
              </a>
            </li>
          ))}
        </ul>
      </div>

      <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-2xl border-l-4 border-blue-400 shadow-md">
        <h4 class="text-lg font-bold text-blue-800 mb-2">Get Your Free Ebook</h4>
        <p class="text-sm text-gray-700 mb-4">AI automation is now table stakes for every company.</p>
        <a href="#" id="open-ebook-modal-sidebar" class="inline-block bg-blue-600 text-white font-bold py-2 px-5 rounded-full text-sm hover:bg-blue-700 transition">
          Get Yours Now
        </a>
      </div>
    </aside>

  </div>
</BaseLayout>
